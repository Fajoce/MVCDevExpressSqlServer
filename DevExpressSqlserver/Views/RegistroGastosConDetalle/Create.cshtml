@model DevExpressSqlserver.Models.Entities.Movimiento
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Registrar Movimiento Gastos con Detalle";
    var tipoGastoSelect = ViewData["TipoGasto"] as SelectList;
}

<link href="https://cdn.jsdelivr.net/npm/devextreme@23.2/dist/css/dx.light.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/devextreme@23.2/dist/js/dx.all.js"></script>
<div class="d-flex justify-content-center">
    <div style="width: 100%; max-width: 900px; align-content:center">
<h2>@ViewData["Title"]</h2>

@if (ViewBag.Alertas != null)
{
    <div class="alert alert-warning">
        <ul>
            @foreach (var alerta in ViewBag.Alertas as List<string>)
            {
                <li>@alerta</li>
            }
        </ul>
    </div>
}


<form asp-action="Create" method="post" onsubmit="return beforeSubmit();">
    <div class="form-group">
        <label>Fondo Monetario</label>
        <select asp-for="FondoID" class="form-control" asp-items="ViewBag.FondosMonetarios"></select>
    </div>

    <div class="form-group">
        <label>Observaciones</label>
        <input asp-for="Observaciones" class="form-control" />
    </div>

    <div class="form-group">
        <label>Nombre del Comercio</label>
        <input asp-for="NombreComercio" class="form-control" />
    </div>

    <div class="form-group">
        <label>Tipo de Documento</label>
        <select asp-for="TipoDocumento" class="form-control">
            <option>Comprobante</option>
            <option>Factura</option>
            <option>Otro</option>
        </select>
    </div>

    <hr />
    <h4>Detalles del Gasto</h4>
    <div id="detalleGrid"></div>
    <input type="hidden" name="detallesJson" id="detallesJson" />

    <br />
    <button type="submit" class="btn btn-primary">Guardar</button>
</form>
</div>
</div>

<script>
    var detalles = [];

    $(function () {
        $("#detalleGrid").dxDataGrid({
            dataSource: detalles,
            editing: {
                mode: "row",
                allowAdding: true,
                allowUpdating: true,
                allowDeleting: true
            },
            columns: [
                {
                    dataField: "TipoGastoID",
                    caption: "Tipo de Gasto",
                    lookup: {
                        dataSource: @Html.Raw(ViewBag.TipoGastoListJson),
                        valueExpr: "TipoGastoID",
                        displayExpr: "Descripcion"
                    },
                    validationRules: [{ type: "required" }]
                },
                {
                    dataField: "Monto",
                    dataType: "number",
                    caption: "Monto",
                    format: "currency",
                    validationRules: [{ type: "required" }]
                }
            ]
        });
    });

    function beforeSubmit() {
        var grid = $("#detalleGrid").dxDataGrid("instance");
        var data = grid.getDataSource().items();
        if (data.length === 0) {
            alert("Debe ingresar al menos un detalle.");
            return false;
        }
        document.getElementById("detallesJson").value = JSON.stringify(data);
        return true;
    }
</script>